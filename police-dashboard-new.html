<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bon Voyage - Police Dashboard</title>
  <link rel="stylesheet" href="styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    .hidden { display: none; }
    .nav-link.active { background: #3b82f6; color: white; }
    .btn-police { 
      background: #2196F3; 
      color: white; 
      border: none; 
      padding: 10px 20px; 
      border-radius: 5px; 
      cursor: pointer; 
      margin: 5px;
    }
    .btn-police:hover { background: #1976D2; }
    .btn-police.secondary { background: #f44336; }
    .btn-police.secondary:hover { background: #d32f2f; }
    .control-group { margin: 10px 0; }
    .control-label { display: block; margin-bottom: 5px; font-weight: 500; }
    .control-input { 
      width: 100%; 
      padding: 8px; 
      border: 1px solid #ddd; 
      border-radius: 4px; 
      box-sizing: border-box;
    }
    .map-container { 
      height: 400px; 
      width: 100%; 
      border: 1px solid #ddd; 
      border-radius: 8px; 
      margin: 10px 0;
    }
    .dashboard-card { 
      background: white; 
      border-radius: 8px; 
      padding: 20px; 
      margin: 20px 0; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .card-title { 
      font-size: 18px; 
      font-weight: 600; 
      margin-bottom: 15px; 
      color: #333;
    }
    .nav-links { 
      display: flex; 
      gap: 10px; 
      margin-bottom: 20px; 
      border-bottom: 1px solid #eee; 
      padding-bottom: 10px;
    }
    .nav-link { 
      padding: 10px 20px; 
      background: #f5f5f5; 
      border: none; 
      border-radius: 5px; 
      cursor: pointer; 
      text-decoration: none; 
      color: #333;
    }
    .nav-link:hover { background: #e0e0e0; }
    .table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-top: 10px;
    }
    .table th, .table td { 
      padding: 10px; 
      text-align: left; 
      border-bottom: 1px solid #ddd;
    }
    .table th { background: #f5f5f5; font-weight: 600; }
    .btn { 
      padding: 5px 10px; 
      border: none; 
      border-radius: 3px; 
      cursor: pointer; 
      margin: 2px;
    }
    .btn-primary { background: #2196F3; color: white; }
    .btn-secondary { background: #757575; color: white; }
    .btn-danger { background: #f44336; color: white; }
  </style>
</head>
<body>
  <div class="container">
    <div class="nav-links">
      <a href="#" class="nav-link active" data-section="dashboard">Dashboard</a>
      <a href="#" class="nav-link" data-section="map">Live Map</a>
      <a href="#" class="nav-link" data-section="emergencies">Emergencies</a>
      <a href="#" class="nav-link" data-section="tourists">Tourists</a>
      <a href="#" class="nav-link" data-section="geofences">Geo-fences</a>
    </div>

    <h1 id="pageTitle">Dashboard Overview</h1>

    <!-- Dashboard Section -->
    <div id="dashboard-section" class="section">
      <div class="dashboard-card">
        <div class="card-title">
          <i class="fas fa-chart-line"></i>
          System Overview
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
          <div>
            <h3>Active Tourists</h3>
            <p id="activeTourists">0</p>
          </div>
          <div>
            <h3>Active Emergencies</h3>
            <p id="activeEmergencies">0</p>
          </div>
          <div>
            <h3>Safety Score</h3>
            <p id="safetyScore">0</p>
          </div>
          <div>
            <h3>Response Time</h3>
            <p id="responseTime">0</p>
          </div>
        </div>
        <p style="margin-top: 20px; color: #666;">Last updated: <span id="lastUpdate"></span></p>
      </div>
    </div>

    <!-- Map Section -->
    <div id="map-section" class="section hidden">
      <div class="dashboard-card">
        <div class="card-title">
          <i class="fas fa-map-marked-alt"></i>
          Geo-fence Management
        </div>
        <div class="map-container" id="policeMap"></div>
        <div class="geo-fence-controls" style="margin-top: 15px;">
          <div class="control-group">
            <label class="control-label">Fence Name *</label>
            <input type="text" id="fenceName" class="control-input" placeholder="Enter fence name" required>
          </div>
          <div class="control-group">
            <label class="control-label">Radius (meters) *</label>
            <input type="number" id="fenceRadius" class="control-input" placeholder="500" value="500" required>
          </div>
          <div class="control-group">
            <label class="control-label">Description</label>
            <input type="text" id="fenceDescription" class="control-input" placeholder="Enter description">
          </div>
          <div class="control-group">
            <label class="control-label">State *</label>
            <input type="text" id="fenceState" class="control-input" placeholder="Enter state" required>
          </div>
          <div class="control-group">
            <label class="control-label">City</label>
            <input type="text" id="fenceCity" class="control-input" placeholder="Enter city (optional)">
          </div>
          <button class="btn-police" onclick="startLocationSelection()">
            <i class="fas fa-map-marker-alt"></i>
            Select on Map
          </button>
          <button class="btn-police secondary" onclick="clearAllFences()">
            <i class="fas fa-trash"></i>
            Clear All Fences
          </button>
        </div>
      </div>
    </div>

    <!-- Emergencies Section -->
    <div id="emergencies-section" class="section hidden">
      <div class="dashboard-card">
        <div class="card-title">
          <i class="fas fa-exclamation-triangle"></i>
          Emergency Alerts
        </div>
        <table class="table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Type</th>
              <th>User</th>
              <th>Location</th>
              <th>Priority</th>
              <th>Status</th>
              <th>Reported</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="emergenciesTableBody">
            <tr><td colspan="8">Loading emergencies...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Tourists Section -->
    <div id="tourists-section" class="section hidden">
      <div class="dashboard-card">
        <div class="card-title">
          <i class="fas fa-users"></i>
          Tourist Data
        </div>
        <table class="table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Phone</th>
              <th>Location</th>
              <th>Safety Score</th>
              <th>Status</th>
              <th>Last Login</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="touristsTableBody">
            <tr><td colspan="8">Loading tourists...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Geo-fences Section -->
    <div id="geofences-section" class="section hidden">
      <div class="dashboard-card">
        <div class="card-title">
          <i class="fas fa-shield-alt"></i>
          Active Geo-fences
        </div>
        <table class="table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Description</th>
              <th>Type</th>
              <th>Location</th>
              <th>Status</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="geofencesTableBody">
            <tr><td colspan="7">Loading geo-fences...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    // Global variables
    let policeMap = null;
    let isSelectingLocation = false;
    let selectedCoordinates = null;
    let selectedLocationMarker = null;
    let previewCircle = null;

    // Navigation
    const navLinks = document.querySelectorAll('.nav-link');
    const sections = document.querySelectorAll('.section');

    navLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const sectionId = link.getAttribute('data-section');

        navLinks.forEach(l => l.classList.remove('active'));
        link.classList.add('active');

        sections.forEach(section => section.classList.add('hidden'));
        document.getElementById(`${sectionId}-section`).classList.remove('hidden');

        // Update page title
        const pageTitle = document.getElementById('pageTitle');
        switch (sectionId) {
          case 'dashboard':
            pageTitle.textContent = 'Dashboard Overview';
            loadDashboard();
            break;
          case 'map':
            pageTitle.textContent = 'Live Map';
            initMap();
            break;
          case 'emergencies':
            pageTitle.textContent = 'Emergency Alerts';
            loadEmergencies();
            break;
          case 'tourists':
            pageTitle.textContent = 'Tourist Data';
            loadTourists();
            break;
          case 'geofences':
            pageTitle.textContent = 'Geofencing';
            loadGeofences();
            break;
        }
      });
    });

    // Initialize map
    function initMap() {
      if (policeMap) return; // Already initialized
      
      policeMap = L.map('policeMap').setView([26.2006, 92.9376], 6);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap'
      }).addTo(policeMap);

      loadMapData();
    }

    // Load map data
    async function loadMapData() {
      if (!policeMap) return;
      
      try {
        const response = await fetch('/api/geofences');
        const result = await response.json();
        const geofences = result.data || [];
        
        // Clear existing layers
        policeMap.eachLayer(layer => {
          if (layer !== policeMap._layers[Object.keys(policeMap._layers)[0]]) {
            policeMap.removeLayer(layer);
          }
        });
        
        // Add geo-fences to map
        geofences.forEach(g => {
          if (g.is_active) {
            const circle = L.circle([parseFloat(g.latitude), parseFloat(g.longitude)], {
              radius: g.radius,
              color: '#ef4444',
              fillColor: '#fecaca',
              fillOpacity: 0.2,
            }).bindPopup(`<strong>${g.name}</strong><br/>${g.description}<br/>State: ${g.state}<br/>Radius: ${g.radius}m`);
            policeMap.addLayer(circle);
          }
        });
      } catch (err) {
        console.error('Failed to load map data:', err);
      }
    }

    // Start location selection
    function startLocationSelection() {
      const name = document.getElementById('fenceName').value;
      const radius = document.getElementById('fenceRadius').value;
      const state = document.getElementById('fenceState').value;
      
      if (!name || !radius || !state) {
        alert('Please fill in Name, Radius, and State fields first');
        return;
      }
      
      isSelectingLocation = true;
      selectedCoordinates = null;
      
      // Update button
      const selectButton = document.querySelector('button[onclick="startLocationSelection()"]');
      if (selectButton) {
        selectButton.textContent = 'Click on Map to Select Location';
        selectButton.style.backgroundColor = '#ff6b6b';
      }
      
      // Add visual indicator to map
      if (policeMap) {
        policeMap.getContainer().style.cursor = 'crosshair';
        
        // Add click handler
        policeMap.off('click.selectLocation');
        policeMap.on('click.selectLocation', function(e) {
          selectedCoordinates = {
            lat: e.latlng.lat,
            lng: e.latlng.lng
          };
          
          // Show selected location
          if (selectedLocationMarker) {
            policeMap.removeLayer(selectedLocationMarker);
          }
          
          selectedLocationMarker = L.marker([e.latlng.lat, e.latlng.lng], {
            icon: L.divIcon({
              className: 'selected-location-marker',
              html: '<div style="background: #ff6b6b; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">📍</div>',
              iconSize: [20, 20]
            })
          }).addTo(policeMap);
          
          // Show preview circle
          if (previewCircle) {
            policeMap.removeLayer(previewCircle);
          }
          
          previewCircle = L.circle([e.latlng.lat, e.latlng.lng], {
            radius: parseInt(radius),
            color: '#ff6b6b',
            fillColor: '#ff6b6b',
            fillOpacity: 0.2,
            weight: 2,
            dashArray: '5, 5'
          }).addTo(policeMap);
          
          // Update button
          if (selectButton) {
            selectButton.textContent = 'Create Geo-fence';
            selectButton.style.backgroundColor = '#4CAF50';
            selectButton.onclick = createGeoFence;
          }
        });
      }
    }

    // Create geo-fence
    async function createGeoFence() {
      if (!selectedCoordinates) {
        alert('Please select a location on the map first');
        return;
      }
      
      const name = document.getElementById('fenceName').value;
      const description = document.getElementById('fenceDescription').value;
      const radius = document.getElementById('fenceRadius').value;
      const state = document.getElementById('fenceState').value;
      const city = document.getElementById('fenceCity').value;
      
      if (!name || !radius || !state) {
        alert('Please fill in all required fields');
        return;
      }
      
      try {
        const response = await fetch('/api/geofences', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name,
            description,
            latitude: selectedCoordinates.lat,
            longitude: selectedCoordinates.lng,
            radius: parseInt(radius),
            state,
            city,
            created_by: 'police_dashboard'
          })
        });
        
        if (response.ok) {
          alert('Geo-fence created successfully!');
          resetGeoFenceForm();
          loadGeofences();
          loadMapData();
        } else {
          alert('Failed to create geo-fence');
        }
      } catch (err) { 
        console.error('Failed to create geo-fence:', err);
        alert('Error creating geo-fence');
      }
    }

    // Reset geo-fence form
    function resetGeoFenceForm() {
      document.getElementById('fenceName').value = '';
      document.getElementById('fenceDescription').value = '';
      document.getElementById('fenceRadius').value = '500';
      document.getElementById('fenceState').value = '';
      document.getElementById('fenceCity').value = '';
      
      isSelectingLocation = false;
      selectedCoordinates = null;
      
      const selectButton = document.querySelector('button[onclick="createGeoFence()"]');
      if (selectButton) {
        selectButton.textContent = 'Select on Map';
        selectButton.style.backgroundColor = '#2196F3';
        selectButton.onclick = startLocationSelection;
      }
      
      if (selectedLocationMarker && policeMap) {
        policeMap.removeLayer(selectedLocationMarker);
        selectedLocationMarker = null;
      }
      
      if (previewCircle && policeMap) {
        policeMap.removeLayer(previewCircle);
        previewCircle = null;
      }
      
      if (policeMap) {
        policeMap.getContainer().style.cursor = '';
        policeMap.off('click.selectLocation');
      }
    }

    // Clear all fences
    async function clearAllFences() {
      if (!confirm('Are you sure you want to clear all geo-fences?')) {
        return;
      }
      
      try {
        const response = await fetch('/api/geofences');
        const result = await response.json();
        const geofences = result.data || [];
        
        for (const geofence of geofences) {
          await fetch(`/api/geofences/${geofence.id}`, {
            method: 'DELETE'
          });
        }
        
        alert('All geo-fences cleared successfully!');
        loadGeofences();
        loadMapData();
      } catch (err) {
        console.error('Failed to clear geo-fences:', err);
        alert('Error clearing geo-fences');
      }
    }

    // Load dashboard
    async function loadDashboard() {
      document.getElementById('lastUpdate').textContent = new Date().toLocaleString();
      document.getElementById('activeTourists').textContent = '0';
      document.getElementById('activeEmergencies').textContent = '0';
      document.getElementById('safetyScore').textContent = '85';
      document.getElementById('responseTime').textContent = '2.5s';
    }

    // Load emergencies
    async function loadEmergencies() {
      try {
        const response = await fetch('/api/emergencies?limit=50');
        const result = await response.json();
        const emergencies = result.data || [];
        const tbody = document.getElementById('emergenciesTableBody');
        
        if (emergencies.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8">No emergencies found</td></tr>';
          return;
        }
        
        tbody.innerHTML = emergencies.map(e => `
          <tr>
            <td>${e.id}</td>
            <td>${e.emergency_type}</td>
            <td>${e.user_name || e.user_email || '-'}</td>
            <td>${e.location_description || (e.latitude+','+e.longitude)}</td>
            <td>${e.priority}</td>
            <td>${e.status}</td>
            <td>${new Date(e.reported_at).toLocaleString()}</td>
            <td>
              <button class="btn btn-secondary" onclick="acknowledge('${e.id}')">Ack</button>
              <button class="btn btn-primary" onclick="dispatch('${e.id}')">Dispatch</button>
              <button class="btn btn-danger" onclick="resolveEmergency('${e.id}')">Resolve</button>
            </td>
          </tr>
        `).join('');
      } catch (err) {
        console.error('Failed to load emergencies:', err);
        document.getElementById('emergenciesTableBody').innerHTML = '<tr><td colspan="8">Error loading emergencies</td></tr>';
      }
    }

    // Load tourists
    async function loadTourists() {
      try {
        const response = await fetch('/api/users?limit=50');
        const result = await response.json();
        const users = result.data || [];
        const tbody = document.getElementById('touristsTableBody');
        
        if (users.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8">No users found</td></tr>';
          return;
        }
        
        tbody.innerHTML = users.map(t => `
          <tr>
            <td>${t.id}</td>
            <td>${t.name}</td>
            <td>${t.phone || '-'}</td>
            <td>${t.latitude && t.longitude ? t.latitude+','+t.longitude : '-'}</td>
            <td>${t.safety_score || '-'}</td>
            <td>${t.is_active ? 'Active' : 'Inactive'}</td>
            <td>${t.last_login ? new Date(t.last_login).toLocaleString() : '-'}</td>
            <td>
              <button class="btn btn-secondary" onclick="viewTourist('${t.id}')">View</button>
            </td>
          </tr>
        `).join('');
      } catch (err) {
        console.error('Failed to load tourists:', err);
        document.getElementById('touristsTableBody').innerHTML = '<tr><td colspan="8">Error loading users</td></tr>';
      }
    }

    // Load geo-fences
    async function loadGeofences() {
      try {
        const response = await fetch('/api/geofences');
        const result = await response.json();
        const geofences = result.data || [];
        const tbody = document.getElementById('geofencesTableBody');
        
        if (geofences.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7">No geo-fences found</td></tr>';
          return;
        }
        
        tbody.innerHTML = geofences.map(g => `
          <tr>
            <td>${g.name}</td>
            <td>${g.description || 'N/A'}</td>
            <td>Circle</td>
            <td>${g.city || g.state}</td>
            <td>${g.is_active ? 'Active' : 'Inactive'}</td>
            <td>${new Date(g.created_at).toLocaleString()}</td>
            <td>
              <button class="btn btn-secondary" onclick="toggleGeoFence('${g.id}')">Toggle</button>
              <button class="btn btn-danger" onclick="deleteGeoFence('${g.id}')">Delete</button>
            </td>
          </tr>
        `).join('');
      } catch (err) {
        console.error('Failed to load geo-fences:', err);
        document.getElementById('geofencesTableBody').innerHTML = '<tr><td colspan="7">Error loading geo-fences</td></tr>';
      }
    }

    // Action functions
    async function acknowledge(id) {
      try {
        const response = await fetch(`/api/emergencies/${id}/acknowledge`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ acknowledged_by: 'police_officer' })
        });
        if (response.ok) {
          loadEmergencies();
        }
      } catch (err) { 
        console.error('Failed to acknowledge emergency:', err);
      }
    }

    async function dispatch(id) {
      try {
        const response = await fetch(`/api/emergencies/${id}/dispatch`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ dispatched_to: 'police_officer' })
        });
        if (response.ok) {
          loadEmergencies();
        }
      } catch (err) { 
        console.error('Failed to dispatch emergency:', err);
      }
    }

    async function resolveEmergency(id) {
      try {
        const response = await fetch(`/api/emergencies/${id}/resolve`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ notes: 'Resolved via police dashboard' })
        });
        if (response.ok) {
          loadEmergencies();
        }
      } catch (err) { 
        console.error('Failed to resolve emergency:', err);
      }
    }

    async function viewTourist(id) {
      try {
        const response = await fetch(`/api/users/${id}`);
        const result = await response.json();
        if (result.success) {
          const user = result.data;
          alert(`User: ${user.name}\nEmail: ${user.email}\nPhone: ${user.phone}\nLocation: ${user.location}\nStatus: ${user.is_active ? 'Active' : 'Inactive'}`);
        }
      } catch (err) { 
        console.error('Failed to view user:', err);
      }
    }

    async function toggleGeoFence(id) {
      try {
        const response = await fetch(`/api/geofences/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ is_active: null })
        });
        if (response.ok) {
          loadGeofences();
          loadMapData();
        }
      } catch (err) { 
        console.error('Failed to toggle geo-fence:', err);
      }
    }

    async function deleteGeoFence(id) {
      if (confirm('Are you sure you want to delete this geo-fence?')) {
        try {
          const response = await fetch(`/api/geofences/${id}`, {
            method: 'DELETE'
          });
          if (response.ok) {
            loadGeofences();
            loadMapData();
          }
        } catch (err) { 
          console.error('Failed to delete geo-fence:', err);
        }
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      loadDashboard();
    });
  </script>
</body>
</html>
