<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bon Voyage - Police Dashboard</title>
  <link rel="stylesheet" href="styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    .police-container {
      min-height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
    }
    
    .police-header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }
    
    .police-title {
      font-size: 28px;
      font-weight: 700;
      color: #1a1a1a;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .police-badge {
      background: linear-gradient(135deg, #dc2626, #b91c1c);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
    }
    
    .dashboard-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .dashboard-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }
    
    .card-title {
      font-size: 18px;
      font-weight: 600;
      color: #1a1a1a;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .map-container {
      height: 400px;
      border-radius: 12px;
      overflow: hidden;
      border: 2px solid #e5e7eb;
    }
    
    .geo-fence-controls {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .control-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .control-label {
      font-weight: 600;
      color: #374151;
      font-size: 14px;
    }
    
    .control-input {
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s ease;
    }
    
    .control-input:focus {
      outline: none;
      border-color: #3b82f6;
    }
    
    .btn-police {
      background: linear-gradient(135deg, #dc2626, #b91c1c);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-police:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(220, 38, 38, 0.3);
    }
    
    .btn-police.secondary {
      background: linear-gradient(135deg, #6b7280, #4b5563);
    }
    
    .btn-police.secondary:hover {
      box-shadow: 0 5px 15px rgba(107, 114, 128, 0.3);
    }
    
    .active-fences {
      max-height: 300px;
      overflow-y: auto;
    }
    
    .fence-item {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .fence-info {
      flex: 1;
    }
    
    .fence-name {
      font-weight: 600;
      color: #1a1a1a;
      margin-bottom: 4px;
    }
    
    .fence-details {
      font-size: 12px;
      color: #6b7280;
    }
    
    .fence-actions {
      display: flex;
      gap: 8px;
    }
    
    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 6px;
    }
    
    .monitoring-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    }
    
    .stat-number {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 5px;
    }
    
    .stat-label {
      font-size: 12px;
      opacity: 0.9;
    }
    
    .user-alerts {
      max-height: 300px;
      overflow-y: auto;
    }
    
    .alert-item {
      background: #fef2f2;
      border: 1px solid #fecaca;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
    }
    
    .alert-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .alert-user {
      font-weight: 600;
      color: #dc2626;
    }
    
    .alert-time {
      font-size: 12px;
      color: #6b7280;
    }
    
    .alert-location {
      font-size: 14px;
      color: #374151;
    }
    
    .alert-fence {
      font-size: 12px;
      color: #6b7280;
      margin-top: 4px;
    }
    
    @media (max-width: 768px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
    }

    .btn-police.small {
      padding: 6px 12px;
      font-size: 12px;
      margin: 2px;
    }

    /* Evidence System Styles */
    .evidence-item {
      background: white;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .evidence-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .evidence-type {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      color: #374151;
    }

    .evidence-type i {
      color: #6b7280;
    }

    .evidence-priority {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
    }

    .evidence-title {
      font-size: 16px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 8px;
    }

    .evidence-description {
      color: #6b7280;
      margin-bottom: 12px;
      line-height: 1.5;
    }

    .evidence-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 8px;
      margin-bottom: 12px;
    }

    .evidence-detail {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
      color: #6b7280;
    }

    .evidence-detail i {
      color: #9ca3af;
      width: 16px;
    }

    .evidence-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 12px;
    }

    .evidence-tag {
      background: #f3f4f6;
      color: #374151;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      border: 1px solid #e5e7eb;
    }

    .evidence-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    /* Form Styles */
    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: #374151;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.2s;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    .form-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #e5e7eb;
    }
  </style>
</head>
<body>
  <div class="police-container">
    <div class="police-header">
      <div class="police-title">
        <i class="fas fa-shield-alt" style="color: #dc2626;"></i>
        <span id="policeTitle">Police Dashboard</span>
        <div class="police-badge" id="policeBadge">Authorized Personnel Only</div>
      </div>
      <p style="color: #6b7280; margin: 0;" id="policeSubtitle">Monitor restricted areas and user activity in real-time</p>
      <div style="margin-top: 10px;">
        <button class="btn-police secondary" onclick="detectPoliceLocation()" style="margin-right: 10px;">
          <i class="fas fa-crosshairs"></i>
          Detect My Location
        </button>
        <button class="btn-police secondary" onclick="toggleAutoDispatch()" id="autoDispatchBtn">
          <i class="fas fa-robot"></i>
          Auto Dispatch: OFF
        </button>
      </div>
    </div>

    <div class="monitoring-stats">
      <div class="stat-card">
        <div class="stat-number" id="totalFences">0</div>
        <div class="stat-label">Active Geo-fences</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="usersInRestricted">0</div>
        <div class="stat-label">Users in Restricted Areas</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="totalAlerts">0</div>
        <div class="stat-label">Total Alerts Today</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="activeUsers">0</div>
        <div class="stat-label">Active Users</div>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
        <div class="stat-number" id="dispatchedUnits">0</div>
        <div class="stat-label">Dispatched Units</div>
      </div>
    </div>

    <div class="dashboard-grid">
      <div class="dashboard-card">
        <div class="card-title">
          <i class="fas fa-map-marked-alt"></i>
          Geo-fence Management
        </div>
        <div class="map-container" id="policeMap"></div>
        <div class="geo-fence-controls" style="margin-top: 15px;">
          <div class="control-group">
            <label class="control-label">Fence Name</label>
            <input type="text" id="fenceName" class="control-input" placeholder="Enter fence name">
          </div>
          <div class="control-group">
            <label class="control-label">Radius (meters)</label>
            <input type="number" id="fenceRadius" class="control-input" placeholder="500" value="500">
          </div>
          <div class="control-group">
            <label class="control-label">Description</label>
            <input type="text" id="fenceDescription" class="control-input" placeholder="Enter description">
          </div>
          <div class="control-group">
            <label class="control-label">State *</label>
            <input type="text" id="fenceState" class="control-input" placeholder="Enter state" required>
          </div>
          <div class="control-group">
            <label class="control-label">City</label>
            <input type="text" id="fenceCity" class="control-input" placeholder="Enter city (optional)">
          </div>
          <button class="btn-police" onclick="startLocationSelection()">
            <i class="fas fa-map-marker-alt"></i>
            Select on Map
          </button>
          <button class="btn-police secondary" onclick="clearAllFences()">
            <i class="fas fa-trash"></i>
            Clear All Fences
          </button>
        </div>
      </div>

      <div class="dashboard-card">
        <div class="card-title">
          <i class="fas fa-list"></i>
          Active Geo-fences
        </div>
        <div class="active-fences" id="activeFences">
          <div style="text-align: center; color: #6b7280; padding: 20px;">
            No active geo-fences
          </div>
        </div>
      </div>
    </div>

    <div class="dashboard-grid">
      <div class="dashboard-card">
        <div class="card-title">
          <i class="fas fa-users"></i>
          User Monitoring
        </div>
        <div class="map-container" id="userMap"></div>
      </div>

      <div class="dashboard-card">
        <div class="card-title">
          <i class="fas fa-bell"></i>
          Recent Alerts
        </div>
        <div class="user-alerts" id="userAlerts">
          <div style="text-align: center; color: #6b7280; padding: 20px;">
            No recent alerts
          </div>
        </div>
      </div>
    </div>

    <div class="dashboard-card" style="margin-top: 20px;">
      <div class="card-title">
        <i class="fas fa-ambulance"></i>
        State-Specific Auto Dispatch System
      </div>
      <div id="dispatchLog" style="max-height: 200px; overflow-y: auto; background: #f8f9fa; border-radius: 8px; padding: 15px;">
        <div style="text-align: center; color: #6b7280; padding: 20px;">
          State-specific auto dispatch system ready. Enable to start automatic unit deployment to respective state police.
        </div>
      </div>
    </div>

    <div class="dashboard-card" style="margin-top: 20px;">
      <div class="card-title">
        <i class="fas fa-folder-open"></i>
        Evidence Logging System
        <button class="btn-police primary" onclick="openEvidenceModal()" style="float: right; margin-top: -5px;">
          <i class="fas fa-plus"></i>
          Log Evidence
        </button>
      </div>
      <div id="evidenceList" style="max-height: 300px; overflow-y: auto;">
        <div style="text-align: center; color: #6b7280; padding: 20px;">
          No evidence logged yet. Click "Log Evidence" to start.
        </div>
      </div>
    </div>
  </div>

  <!-- Evidence Logging Modal -->
  <div id="evidenceModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h3><i class="fas fa-folder-open"></i> Log Evidence</h3>
        <button class="close-btn" onclick="closeEvidenceModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="evidenceForm">
          <div class="form-group">
            <label for="evidenceType">Evidence Type:</label>
            <select id="evidenceType" required>
              <option value="">Select Evidence Type</option>
              <option value="photo">Photograph</option>
              <option value="video">Video Recording</option>
              <option value="audio">Audio Recording</option>
              <option value="document">Document</option>
              <option value="witness">Witness Statement</option>
              <option value="physical">Physical Evidence</option>
              <option value="digital">Digital Evidence</option>
              <option value="other">Other</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="evidenceTitle">Evidence Title:</label>
            <input type="text" id="evidenceTitle" placeholder="Brief description of evidence" required>
          </div>
          
          <div class="form-group">
            <label for="evidenceDescription">Description:</label>
            <textarea id="evidenceDescription" rows="4" placeholder="Detailed description of the evidence" required></textarea>
          </div>
          
          <div class="form-group">
            <label for="evidenceLocation">Location:</label>
            <input type="text" id="evidenceLocation" placeholder="Where was this evidence found/collected?">
          </div>
          
          <div class="form-group">
            <label for="evidenceIncident">Related Incident/Case:</label>
            <input type="text" id="evidenceIncident" placeholder="Case number or incident reference">
          </div>
          
          <div class="form-group">
            <label for="evidenceOfficer">Collecting Officer:</label>
            <input type="text" id="evidenceOfficer" placeholder="Officer name and badge number" required>
          </div>
          
          <div class="form-group">
            <label for="evidencePriority">Priority Level:</label>
            <select id="evidencePriority" required>
              <option value="low">Low</option>
              <option value="medium" selected>Medium</option>
              <option value="high">High</option>
              <option value="critical">Critical</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="evidenceTags">Tags (comma-separated):</label>
            <input type="text" id="evidenceTags" placeholder="e.g., geo-fence, violation, user-report">
          </div>
          
          <div class="form-group">
            <label for="evidenceFile">Upload File (Optional):</label>
            <input type="file" id="evidenceFile" accept="image/*,video/*,audio/*,.pdf,.doc,.docx">
          </div>
          
          <div class="form-actions">
            <button type="button" class="btn-police secondary" onclick="closeEvidenceModal()">Cancel</button>
            <button type="submit" class="btn-police primary">Log Evidence</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="public/police-dashboard.js"></script>
  <script>
    let policeMap, userMap;
    let geoFences = [];
    let userMarkers = [];
    let currentUser = null;
    let currentPoliceState = null;
    let autoDispatchEnabled = false;
    let dispatchedUnits = 0;
    let evidenceLog = [];
    let stateBounds = {
      'Maharashtra': { 
        center: [19.8, 76.7], 
        police: 'Mumbai Police',
        bounds: [
          [15.6, 72.6], [15.6, 73.0], [16.0, 73.5], [16.5, 74.0], [17.0, 74.5], 
          [17.5, 75.0], [18.0, 75.5], [18.5, 76.0], [19.0, 76.5], [19.5, 77.0], 
          [20.0, 77.5], [20.5, 78.0], [21.0, 78.5], [21.5, 79.0], [22.0, 79.5], 
          [22.0, 80.0], [21.5, 80.5], [21.0, 80.9], [20.5, 80.7], [20.0, 80.5], 
          [19.5, 80.3], [19.0, 80.1], [18.5, 79.9], [18.0, 79.7], [17.5, 79.5], 
          [17.0, 79.3], [16.5, 79.1], [16.0, 78.9], [15.6, 78.7], [15.6, 72.6]
        ]
      },
      'Assam': { 
        center: [26.0, 92.8], 
        police: 'Assam Police',
        bounds: [
          [24.0, 89.7], [24.5, 90.0], [25.0, 90.5], [25.5, 91.0], [26.0, 91.5], 
          [26.5, 92.0], [27.0, 92.5], [27.5, 93.0], [28.0, 93.5], [28.0, 94.0], 
          [27.5, 94.5], [27.0, 95.0], [26.5, 95.5], [26.0, 96.0], [25.5, 95.5], 
          [25.0, 95.0], [24.5, 94.5], [24.0, 94.0], [24.0, 89.7]
        ]
      },
      'Delhi': { 
        center: [28.6, 77.0], 
        police: 'Delhi Police',
        bounds: [
          [28.4, 76.8], [28.4, 77.0], [28.6, 77.0], [28.8, 77.0], [28.9, 77.0], 
          [28.9, 77.2], [28.9, 77.3], [28.7, 77.3], [28.5, 77.3], [28.4, 77.3], 
          [28.4, 77.1], [28.4, 76.8]
        ]
      },
      'Uttar Pradesh': { 
        center: [27.3, 80.8], 
        police: 'UP Police',
        bounds: [
          [23.6, 77.0], [24.0, 77.5], [24.5, 78.0], [25.0, 78.5], [25.5, 79.0], 
          [26.0, 79.5], [26.5, 80.0], [27.0, 80.5], [27.5, 81.0], [28.0, 81.5], 
          [28.5, 82.0], [29.0, 82.5], [29.5, 83.0], [30.0, 83.5], [30.5, 84.0], 
          [31.0, 84.5], [31.0, 84.6], [30.5, 84.3], [30.0, 84.0], [29.5, 83.7], 
          [29.0, 83.4], [28.5, 83.1], [28.0, 82.8], [27.5, 82.5], [27.0, 82.2], 
          [26.5, 81.9], [26.0, 81.6], [25.5, 81.3], [25.0, 81.0], [24.5, 80.7], 
          [24.0, 80.4], [23.6, 80.1], [23.6, 77.0]
        ]
      },
      'Rajasthan': { 
        center: [26.5, 73.7], 
        police: 'Rajasthan Police',
        bounds: [
          [23.0, 69.3], [23.5, 70.0], [24.0, 70.5], [24.5, 71.0], [25.0, 71.5], 
          [25.5, 72.0], [26.0, 72.5], [26.5, 73.0], [27.0, 73.5], [27.5, 74.0], 
          [28.0, 74.5], [28.5, 75.0], [29.0, 75.5], [29.5, 76.0], [30.0, 76.5], 
          [30.1, 77.0], [30.1, 78.1], [29.5, 77.8], [29.0, 77.5], [28.5, 77.2], 
          [28.0, 76.9], [27.5, 76.6], [27.0, 76.3], [26.5, 76.0], [26.0, 75.7], 
          [25.5, 75.4], [25.0, 75.1], [24.5, 74.8], [24.0, 74.5], [23.5, 74.2], 
          [23.0, 73.9], [23.0, 69.3]
        ]
      },
      'Karnataka': { 
        center: [15.0, 76.3], 
        police: 'Karnataka Police',
        bounds: [
          [11.5, 74.0], [12.0, 74.5], [12.5, 75.0], [13.0, 75.5], [13.5, 76.0], 
          [14.0, 76.5], [14.5, 77.0], [15.0, 77.5], [15.5, 78.0], [16.0, 78.5], 
          [16.5, 78.6], [17.0, 78.4], [17.5, 78.2], [18.0, 78.0], [18.4, 77.8], 
          [18.4, 77.5], [18.0, 77.2], [17.5, 76.9], [17.0, 76.6], [16.5, 76.3], 
          [16.0, 76.0], [15.5, 75.7], [15.0, 75.4], [14.5, 75.1], [14.0, 74.8], 
          [13.5, 74.5], [13.0, 74.2], [12.5, 74.0], [12.0, 74.0], [11.5, 74.0]
        ]
      },
      'Tamil Nadu': { 
        center: [10.7, 78.2], 
        police: 'Tamil Nadu Police',
        bounds: [
          [8.0, 76.2], [8.5, 76.5], [9.0, 76.8], [9.5, 77.1], [10.0, 77.4], 
          [10.5, 77.7], [11.0, 78.0], [11.5, 78.3], [12.0, 78.6], [12.5, 78.9], 
          [13.0, 79.2], [13.3, 79.5], [13.3, 80.0], [13.3, 80.3], [13.0, 80.1], 
          [12.5, 79.9], [12.0, 79.7], [11.5, 79.5], [11.0, 79.3], [10.5, 79.1], 
          [10.0, 78.9], [9.5, 78.7], [9.0, 78.5], [8.5, 78.3], [8.0, 78.1], 
          [8.0, 76.2]
        ]
      },
      'Kerala': { 
        center: [10.5, 76.0], 
        police: 'Kerala Police',
        bounds: [
          [8.2, 74.8], [8.5, 75.0], [9.0, 75.2], [9.5, 75.4], [10.0, 75.6], 
          [10.5, 75.8], [11.0, 76.0], [11.5, 76.2], [12.0, 76.4], [12.5, 76.6], 
          [12.8, 76.8], [12.8, 77.0], [12.8, 77.3], [12.5, 77.1], [12.0, 76.9], 
          [11.5, 76.7], [11.0, 76.5], [10.5, 76.3], [10.0, 76.1], [9.5, 75.9], 
          [9.0, 75.7], [8.5, 75.5], [8.2, 75.3], [8.2, 74.8]
        ]
      },
      'Punjab': { 
        center: [30.9, 75.4], 
        police: 'Punjab Police',
        bounds: [
          [29.5, 73.9], [30.0, 74.2], [30.5, 74.5], [31.0, 74.8], [31.5, 75.1], 
          [32.0, 75.4], [32.3, 75.7], [32.3, 76.0], [32.3, 76.3], [32.3, 76.6], 
          [32.3, 76.9], [32.0, 76.7], [31.5, 76.5], [31.0, 76.3], [30.5, 76.1], 
          [30.0, 75.9], [29.5, 75.7], [29.5, 75.4], [29.5, 75.1], [29.5, 74.8], 
          [29.5, 74.5], [29.5, 74.2], [29.5, 73.9]
        ]
      },
      'West Bengal': { 
        center: [24.4, 87.8], 
        police: 'West Bengal Police',
        bounds: [
          [21.6, 85.8], [22.0, 86.2], [22.5, 86.6], [23.0, 87.0], [23.5, 87.4], 
          [24.0, 87.8], [24.5, 88.2], [25.0, 88.6], [25.5, 89.0], [26.0, 89.4], 
          [26.5, 89.8], [27.0, 89.9], [27.2, 89.7], [27.2, 89.4], [27.2, 89.1], 
          [27.2, 88.8], [27.2, 88.5], [27.2, 88.2], [27.2, 87.9], [27.2, 87.6], 
          [27.2, 87.3], [27.2, 87.0], [27.2, 86.7], [27.2, 86.4], [27.2, 86.1], 
          [27.2, 85.8], [21.6, 85.8]
        ]
      },
      'Gujarat': { 
        center: [22.4, 71.3], 
        police: 'Gujarat Police',
        bounds: [
          [20.1, 68.2], [20.5, 68.8], [21.0, 69.4], [21.5, 70.0], [22.0, 70.6], 
          [22.5, 71.2], [23.0, 71.8], [23.5, 72.4], [24.0, 73.0], [24.5, 73.6], 
          [24.7, 74.2], [24.7, 74.5], [24.5, 74.3], [24.0, 74.1], [23.5, 73.9], 
          [23.0, 73.7], [22.5, 73.5], [22.0, 73.3], [21.5, 73.1], [21.0, 72.9], 
          [20.5, 72.7], [20.1, 72.5], [20.1, 68.2]
        ]
      }
    };

    // Initialize maps
    function initMaps() {
      // Detect police location first
      detectPoliceLocation();
      
      // Default to India center if no state detected
      const defaultCenter = [20.5937, 78.9629];
      const defaultZoom = 5;
      
      // Police map for geo-fence management
      policeMap = L.map('policeMap').setView(defaultCenter, defaultZoom);
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
      }).addTo(policeMap);

      // User monitoring map
      userMap = L.map('userMap').setView(defaultCenter, defaultZoom);
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
      }).addTo(userMap);
      

      // Geo-fence creation is now handled by public/police-dashboard.js

      // Geo-fence loading is now handled by public/police-dashboard.js
      
      // Start monitoring
      startUserMonitoring();
    }

    // Geo-fence creation is now handled by public/police-dashboard.js

    // Create geo-fence function is now handled by public/police-dashboard.js

    // Update fence display
    function updateFenceDisplay() {
      // Clear existing fences
      policeMap.eachLayer(layer => {
        if (layer instanceof L.Circle) {
          policeMap.removeLayer(layer);
        }
      });

      // Add fences to police map
      geoFences.forEach(fence => {
        if (fence.active) {
          const circle = L.circle([fence.lat, fence.lng], {
            color: '#dc2626',
            fillColor: '#dc2626',
            fillOpacity: 0.2,
            radius: fence.radius
          }).addTo(policeMap);

          circle.bindPopup(`
            <strong>${fence.name}</strong><br>
            ${fence.description}<br>
            <small>Radius: ${fence.radius}m</small>
          `);
        }
      });

      // Update fence list
      updateFenceList();
    }

    // Update fence list
    function updateFenceList() {
      const container = document.getElementById('activeFences');
      
      if (geoFences.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: #6b7280; padding: 20px;">No active geo-fences</div>';
        return;
      }

      container.innerHTML = geoFences.map(fence => `
        <div class="fence-item">
          <div class="fence-info">
            <div class="fence-name">${fence.name}</div>
            <div class="fence-details">
              ${fence.lat.toFixed(4)}, ${fence.lng.toFixed(4)} • ${fence.radius}m radius
            </div>
          </div>
          <div class="fence-actions">
            <button class="btn-police btn-small secondary" onclick="toggleFence(${fence.id})">
              <i class="fas fa-${fence.active ? 'pause' : 'play'}"></i>
            </button>
            <button class="btn-police btn-small" onclick="deleteFence(${fence.id})" style="background: #dc2626;">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
      `).join('');
    }

    // Toggle fence active status
    function toggleFence(id) {
      const fence = geoFences.find(f => f.id === id);
      if (fence) {
        fence.active = !fence.active;
        saveGeoFences();
        updateFenceDisplay();
        updateStats();
      }
    }

    // Delete fence
    function deleteFence(id) {
      if (confirm('Are you sure you want to delete this geo-fence?')) {
        geoFences = geoFences.filter(f => f.id !== id);
        saveGeoFences();
        updateFenceDisplay();
        updateStats();
      }
    }

    // Clear all fences
    function clearAllFences() {
      if (confirm('Are you sure you want to clear all geo-fences?')) {
        geoFences = [];
        saveGeoFences();
        updateFenceDisplay();
        updateStats();
      }
    }

    // Save geo-fences to localStorage
    function saveGeoFences() {
      localStorage.setItem('bon_voyage_geo_fences', JSON.stringify(geoFences));
    }

    // Load geo-fences from localStorage
    function loadGeoFences() {
      const saved = localStorage.getItem('bon_voyage_geo_fences');
      if (saved) {
        geoFences = JSON.parse(saved);
        updateFenceDisplay();
        updateStats();
      }
    }

    // Update statistics
    function updateStats() {
      document.getElementById('totalFences').textContent = geoFences.filter(f => f.active).length;
      document.getElementById('usersInRestricted').textContent = userMarkers.length;
      document.getElementById('totalAlerts').textContent = getTotalAlerts();
      document.getElementById('activeUsers').textContent = getActiveUsers();
      document.getElementById('dispatchedUnits').textContent = dispatchedUnits;
    }

    // Get total alerts (mock data)
    function getTotalAlerts() {
      return Math.floor(Math.random() * 50) + 10;
    }

    // Get active users (mock data)
    function getActiveUsers() {
      return Math.floor(Math.random() * 200) + 50;
    }

    // Start user monitoring
    function startUserMonitoring() {
      // Simulate user locations and monitoring
      setInterval(() => {
        simulateUserActivity();
      }, 5000);
    }

    // Simulate user activity
    function simulateUserActivity() {
      // Clear existing user markers
      userMarkers.forEach(marker => userMap.removeLayer(marker));
      userMarkers = [];

      // Generate random user locations
      const userCount = Math.floor(Math.random() * 10) + 5;
      
      for (let i = 0; i < userCount; i++) {
        const lat = 20.5937 + (Math.random() - 0.5) * 10;
        const lng = 78.9629 + (Math.random() - 0.5) * 10;
        
        // Check if user is in restricted area
        const inRestricted = isInRestrictedArea(lat, lng);
        
        const marker = L.marker([lat, lng], {
          icon: L.divIcon({
            className: 'user-marker',
            html: `<div style="background: ${inRestricted ? '#dc2626' : '#10b981'}; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 10px;"><i class="fas fa-user"></i></div>`,
            iconSize: [20, 20]
          })
        }).addTo(userMap);

        marker.bindPopup(`
          <strong>User ${i + 1}</strong><br>
          Status: ${inRestricted ? 'In Restricted Area' : 'Safe'}<br>
          Time: ${new Date().toLocaleTimeString()}
        `);

        userMarkers.push(marker);

        // Generate alert if in restricted area
        if (inRestricted && Math.random() > 0.7) {
          generateAlert(lat, lng, i + 1);
        }
      }

      updateStats();
    }

    // Check if location is in restricted area
    function isInRestrictedArea(lat, lng) {
      return geoFences.some(fence => {
        if (!fence.active) return false;
        
        const distance = getDistanceFromLatLonInMeters(lat, lng, fence.lat, fence.lng);
        return distance <= fence.radius;
      });
    }

    // Calculate distance between two points
    function getDistanceFromLatLonInMeters(lat1, lon1, lat2, lon2) {
      const R = 6371000; // Radius of the earth in meters
      const dLat = deg2rad(lat2 - lat1);
      const dLon = deg2rad(lon2 - lon1);
      const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
        Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      const d = R * c; // Distance in meters
      return d;
    }

    function deg2rad(deg) {
      return deg * (Math.PI/180);
    }

    // Generate alert
    function generateAlert(lat, lng, userId) {
      const fence = geoFences.find(f => {
        if (!f.active) return false;
        const distance = getDistanceFromLatLonInMeters(lat, lng, f.lat, f.lng);
        return distance <= f.radius;
      });

      if (fence) {
        const alert = {
          id: Date.now(),
          userId: userId,
          fenceName: fence.name,
          lat: lat,
          lng: lng,
          time: new Date(),
          message: `User ${userId} entered restricted area: ${fence.name}`
        };

        addAlert(alert);
        
        // Trigger state-specific auto dispatch
        autoDispatchToStatePolice(lat, lng, fence.name, userId);
      }
    }

    // Add alert to display
    function addAlert(alert) {
      const container = document.getElementById('userAlerts');
      const alertElement = document.createElement('div');
      alertElement.className = 'alert-item';
      alertElement.innerHTML = `
        <div class="alert-header">
          <div class="alert-user">User ${alert.userId}</div>
          <div class="alert-time">${alert.time.toLocaleTimeString()}</div>
        </div>
        <div class="alert-location">${alert.lat.toFixed(4)}, ${alert.lng.toFixed(4)}</div>
        <div class="alert-fence">Entered: ${alert.fenceName}</div>
      `;

      container.insertBefore(alertElement, container.firstChild);

      // Keep only last 10 alerts
      while (container.children.length > 10) {
        container.removeChild(container.lastChild);
      }
    }


    // Detect police location and set state-specific view
    function detectPoliceLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          function(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            
            // Detect state from coordinates
            const detectedState = detectStateFromCoordinates(lat, lng);
            currentPoliceState = detectedState;
            
            // Update UI
            updatePoliceDashboardUI(detectedState);
            
            // Set map view to state center
            if (stateBounds[detectedState]) {
              const stateCenter = stateBounds[detectedState].center;
              const stateZoom = 7; // Closer zoom for state view
              
              if (policeMap) {
                policeMap.setView(stateCenter, stateZoom);
              }
              if (userMap) {
                userMap.setView(stateCenter, stateZoom);
              }
            }
            
            
            addDispatchLog(`Location detected: ${detectedState} Police Station`, 'info');
          },
          function(error) {
            console.error('Geolocation error:', error);
            currentPoliceState = 'India';
            updatePoliceDashboardUI('India');
            addDispatchLog('Location detection failed. Using default India view.', 'warning');
          }
        );
      } else {
        currentPoliceState = 'India';
        updatePoliceDashboardUI('India');
        addDispatchLog('Geolocation not supported. Using default India view.', 'warning');
      }
    }

    // Detect state from coordinates
    function detectStateFromCoordinates(lat, lng) {
      for (const [state, stateData] of Object.entries(stateBounds)) {
        // Simple bounding box check for now (can be enhanced with proper polygon point-in-polygon algorithm)
        const bounds = stateData.bounds;
        const minLat = Math.min(...bounds.map(point => point[0]));
        const maxLat = Math.max(...bounds.map(point => point[0]));
        const minLng = Math.min(...bounds.map(point => point[1]));
        const maxLng = Math.max(...bounds.map(point => point[1]));
        
        if (lat >= minLat && lat <= maxLat && lng >= minLng && lng <= maxLng) {
          return state;
        }
      }
      return 'India';
    }

    // Update police dashboard UI based on detected state
    function updatePoliceDashboardUI(state) {
      document.getElementById('policeTitle').textContent = `${state} Police Dashboard`;
      document.getElementById('policeBadge').textContent = `${state} Police Authority`;
      document.getElementById('policeSubtitle').textContent = `Monitor restricted areas and user activity in ${state}`;
    }

    // Toggle auto dispatch
    function toggleAutoDispatch() {
      autoDispatchEnabled = !autoDispatchEnabled;
      const btn = document.getElementById('autoDispatchBtn');
      
      if (autoDispatchEnabled) {
        btn.innerHTML = '<i class="fas fa-robot"></i> Auto Dispatch: ON';
        btn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
        addDispatchLog('State-specific auto dispatch system activated', 'success');
      } else {
        btn.innerHTML = '<i class="fas fa-robot"></i> Auto Dispatch: OFF';
        btn.style.background = 'linear-gradient(135deg, #6b7280, #4b5563)';
        addDispatchLog('State-specific auto dispatch system deactivated', 'info');
      }
    }

    // Auto dispatch to state-specific police when restricted area entry detected
    function autoDispatchToStatePolice(lat, lng, fenceName, userId) {
      if (!autoDispatchEnabled) return;
      
      // Detect which state the incident occurred in
      const incidentState = detectStateFromCoordinates(lat, lng);
      const statePolice = stateBounds[incidentState]?.police || 'Local Police';
      
      dispatchedUnits++;
      const unitId = `UNIT-${String(dispatchedUnits).padStart(3, '0')}`;
      
      // Simulate dispatch time
      const dispatchTime = new Date();
      const eta = new Date(dispatchTime.getTime() + (Math.random() * 10 + 5) * 60000); // 5-15 minutes
      
      addDispatchLog(`🚨 STATE DISPATCH: ${unitId} dispatched to ${statePolice}`, 'critical');
      addDispatchLog(`📍 Location: ${lat.toFixed(4)}, ${lng.toFixed(4)} (${incidentState})`, 'info');
      addDispatchLog(`👤 User ID: ${userId} | ETA: ${eta.toLocaleTimeString()}`, 'info');
      addDispatchLog(`🏛️ Contacting: ${statePolice} for jurisdiction`, 'info');
      
      // Update stats
      updateStats();
      
      // Simulate unit arrival
      setTimeout(() => {
        addDispatchLog(`✅ ${unitId} arrived at scene (${statePolice} jurisdiction)`, 'success');
      }, (Math.random() * 10 + 5) * 60000);
    }

    // Add log entry to dispatch log
    function addDispatchLog(message, type = 'info') {
      const container = document.getElementById('dispatchLog');
      const logEntry = document.createElement('div');
      
      const colors = {
        info: '#3b82f6',
        success: '#10b981',
        warning: '#f59e0b',
        critical: '#dc2626'
      };
      
      logEntry.style.cssText = `
        padding: 8px 12px;
        margin-bottom: 8px;
        border-radius: 6px;
        background: ${colors[type]}20;
        border-left: 4px solid ${colors[type]};
        font-size: 14px;
        color: #374151;
      `;
      
      logEntry.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <span>${message}</span>
          <small style="color: #6b7280;">${new Date().toLocaleTimeString()}</small>
        </div>
      `;
      
      // Clear "ready" message if it exists
      if (container.children.length === 1 && container.children[0].style.textAlign === 'center') {
        container.innerHTML = '';
      }
      
      container.insertBefore(logEntry, container.firstChild);
      
      // Keep only last 20 log entries
      while (container.children.length > 20) {
        container.removeChild(container.lastChild);
      }
    }

    // Evidence Logging Functions
    function openEvidenceModal() {
      document.getElementById('evidenceModal').style.display = 'flex';
      // Auto-fill current location if available
      if (currentPoliceState) {
        document.getElementById('evidenceLocation').value = currentPoliceState;
      }
    }

    function closeEvidenceModal() {
      document.getElementById('evidenceModal').style.display = 'none';
      document.getElementById('evidenceForm').reset();
    }

    function logEvidence(evidenceData) {
      const evidence = {
        id: Date.now(),
        type: evidenceData.type,
        title: evidenceData.title,
        description: evidenceData.description,
        location: evidenceData.location,
        incident: evidenceData.incident,
        officer: evidenceData.officer,
        priority: evidenceData.priority,
        tags: evidenceData.tags ? evidenceData.tags.split(',').map(tag => tag.trim()) : [],
        file: evidenceData.file,
        timestamp: new Date(),
        status: 'logged'
      };

      evidenceLog.push(evidence);
      saveEvidenceLog();
      renderEvidenceList();
      addDispatchLog(`📁 Evidence logged: ${evidence.title} (${evidence.type})`, 'info');
    }

    function saveEvidenceLog() {
      localStorage.setItem('bon_voyage_evidence_log', JSON.stringify(evidenceLog));
    }

    function loadEvidenceLog() {
      const saved = localStorage.getItem('bon_voyage_evidence_log');
      if (saved) {
        evidenceLog = JSON.parse(saved);
      }
    }

    function renderEvidenceList() {
      const container = document.getElementById('evidenceList');
      
      if (evidenceLog.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: #6b7280; padding: 20px;">No evidence logged yet. Click "Log Evidence" to start.</div>';
        return;
      }

      container.innerHTML = '';
      
      // Sort by timestamp (newest first)
      const sortedEvidence = evidenceLog.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      
      sortedEvidence.forEach(evidence => {
        const evidenceElement = document.createElement('div');
        evidenceElement.className = 'evidence-item';
        
        const priorityColors = {
          low: '#10b981',
          medium: '#f59e0b',
          high: '#ef4444',
          critical: '#dc2626'
        };
        
        const typeIcons = {
          photo: 'fas fa-camera',
          video: 'fas fa-video',
          audio: 'fas fa-microphone',
          document: 'fas fa-file-alt',
          witness: 'fas fa-user-friends',
          physical: 'fas fa-box',
          digital: 'fas fa-laptop',
          other: 'fas fa-folder'
        };
        
        evidenceElement.innerHTML = `
          <div class="evidence-header">
            <div class="evidence-type">
              <i class="${typeIcons[evidence.type] || 'fas fa-folder'}"></i>
              <span>${evidence.type.toUpperCase()}</span>
            </div>
            <div class="evidence-priority" style="background: ${priorityColors[evidence.priority]}20; color: ${priorityColors[evidence.priority]}; border: 1px solid ${priorityColors[evidence.priority]}40;">
              ${evidence.priority.toUpperCase()}
            </div>
          </div>
          <div class="evidence-title">${evidence.title}</div>
          <div class="evidence-description">${evidence.description}</div>
          <div class="evidence-details">
            <div class="evidence-detail">
              <i class="fas fa-map-marker-alt"></i>
              <span>${evidence.location || 'Not specified'}</span>
            </div>
            <div class="evidence-detail">
              <i class="fas fa-user-shield"></i>
              <span>${evidence.officer}</span>
            </div>
            <div class="evidence-detail">
              <i class="fas fa-clock"></i>
              <span>${new Date(evidence.timestamp).toLocaleString()}</span>
            </div>
            ${evidence.incident ? `
              <div class="evidence-detail">
                <i class="fas fa-exclamation-triangle"></i>
                <span>Case: ${evidence.incident}</span>
              </div>
            ` : ''}
          </div>
          ${evidence.tags.length > 0 ? `
            <div class="evidence-tags">
              ${evidence.tags.map(tag => `<span class="evidence-tag">${tag}</span>`).join('')}
            </div>
          ` : ''}
          <div class="evidence-actions">
            <button class="btn-police secondary small" onclick="viewEvidence('${evidence.id}')">
              <i class="fas fa-eye"></i> View
            </button>
            <button class="btn-police secondary small" onclick="editEvidence('${evidence.id}')">
              <i class="fas fa-edit"></i> Edit
            </button>
            <button class="btn-police danger small" onclick="deleteEvidence('${evidence.id}')">
              <i class="fas fa-trash"></i> Delete
            </button>
          </div>
        `;
        
        container.appendChild(evidenceElement);
      });
    }

    function viewEvidence(evidenceId) {
      const evidence = evidenceLog.find(e => e.id == evidenceId);
      if (evidence) {
        alert(`Evidence Details:\n\nTitle: ${evidence.title}\nType: ${evidence.type}\nDescription: ${evidence.description}\nLocation: ${evidence.location}\nOfficer: ${evidence.officer}\nPriority: ${evidence.priority}\nTimestamp: ${new Date(evidence.timestamp).toLocaleString()}\nTags: ${evidence.tags.join(', ')}`);
      }
    }

    function editEvidence(evidenceId) {
      const evidence = evidenceLog.find(e => e.id == evidenceId);
      if (evidence) {
        // Pre-fill form with existing data
        document.getElementById('evidenceType').value = evidence.type;
        document.getElementById('evidenceTitle').value = evidence.title;
        document.getElementById('evidenceDescription').value = evidence.description;
        document.getElementById('evidenceLocation').value = evidence.location || '';
        document.getElementById('evidenceIncident').value = evidence.incident || '';
        document.getElementById('evidenceOfficer').value = evidence.officer;
        document.getElementById('evidencePriority').value = evidence.priority;
        document.getElementById('evidenceTags').value = evidence.tags.join(', ');
        
        openEvidenceModal();
        
        // Store the ID for updating
        document.getElementById('evidenceForm').dataset.editingId = evidenceId;
      }
    }

    function deleteEvidence(evidenceId) {
      if (confirm('Are you sure you want to delete this evidence? This action cannot be undone.')) {
        evidenceLog = evidenceLog.filter(e => e.id != evidenceId);
        saveEvidenceLog();
        renderEvidenceList();
        addDispatchLog(`🗑️ Evidence deleted: ID ${evidenceId}`, 'warning');
      }
    }

    // Handle evidence form submission
    document.addEventListener('DOMContentLoaded', function() {
      const evidenceForm = document.getElementById('evidenceForm');
      if (evidenceForm) {
        evidenceForm.addEventListener('submit', function(e) {
          e.preventDefault();
          
          const formData = {
            type: document.getElementById('evidenceType').value,
            title: document.getElementById('evidenceTitle').value,
            description: document.getElementById('evidenceDescription').value,
            location: document.getElementById('evidenceLocation').value,
            incident: document.getElementById('evidenceIncident').value,
            officer: document.getElementById('evidenceOfficer').value,
            priority: document.getElementById('evidencePriority').value,
            tags: document.getElementById('evidenceTags').value,
            file: document.getElementById('evidenceFile').files[0]?.name || null
          };
          
          const editingId = evidenceForm.dataset.editingId;
          if (editingId) {
            // Update existing evidence
            const evidenceIndex = evidenceLog.findIndex(e => e.id == editingId);
            if (evidenceIndex !== -1) {
              evidenceLog[evidenceIndex] = {
                ...evidenceLog[evidenceIndex],
                ...formData,
                tags: formData.tags ? formData.tags.split(',').map(tag => tag.trim()) : [],
                timestamp: evidenceLog[evidenceIndex].timestamp // Keep original timestamp
              };
              saveEvidenceLog();
              renderEvidenceList();
              addDispatchLog(`📝 Evidence updated: ${formData.title}`, 'info');
            }
            delete evidenceForm.dataset.editingId;
          } else {
            // Create new evidence
            logEvidence(formData);
          }
          
          closeEvidenceModal();
        });
      }
    });

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      initMaps();
      updateStats();
      loadEvidenceLog();
      renderEvidenceList();
    });
  </script>
</body>
</html>
